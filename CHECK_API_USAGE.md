# API使用状況の確認方法

**問題**: 「そんなにDLされてないのに上限にいったというのが不思議」

---

## 🔍 確認方法1: Google Cloud Console（最も正確）

### 手順

1. **Google Cloud Console** にアクセス
   - https://console.cloud.google.com/

2. **プロジェクトを選択**
   - GYM MATCHのプロジェクト

3. **APIs & Services** → **Enabled APIs & services**

4. **Generative Language API** をクリック

5. **Quotas & System Limits** タブを確認

### 確認できる情報

| 項目 | 無料枠上限 | 確認方法 |
|------|-----------|---------|
| リクエスト/分 (RPM) | 15 | Quotasページ |
| リクエスト/日 (RPD) | 1,500 | Quotasページ |
| トークン/分 (TPM) | 1,000,000 | Quotasページ |

### 期待される結果

- **DL数が少ない場合**: RPDは1,500に遠く及ばないはず
- **429エラーが出た場合**: RPM (15回/分) に達した可能性が高い

---

## 🔍 確認方法2: Firebase Console（Firestore）

### 手順

1. **Firebase Console** にアクセス
   - https://console.firebase.google.com/

2. **Firestore Database** を開く

3. **`ai_usage_logs` コレクション** を確認

### クエリ例

```
コレクション: ai_usage_logs
フィルター: timestamp >= 今日の00:00:00
ソート: timestamp desc
```

### 確認できる情報

各ログには以下の情報が含まれます：
- `user_id`: どのユーザーが使用したか
- `feature_type`: どの機能を使用したか（'menu', 'prediction', 'analysis'）
- `timestamp`: いつ使用したか
- `device_id`: どのデバイスから使用したか

### 分析方法

#### 今日の総使用回数
```javascript
// Firestoreコンソールで実行できないが、参考として
db.collection('ai_usage_logs')
  .where('timestamp', '>=', startOfToday)
  .count()
```

#### 特定ユーザーの使用回数
```javascript
db.collection('ai_usage_logs')
  .where('user_id', '==', 'USER_ID')
  .where('timestamp', '>=', startOfToday)
  .count()
```

#### 1分間の最大リクエスト数
1. timestampでソート
2. 連続した15件のタイムスタンプを確認
3. 1分以内に15回以上あれば、RPM制限に達した

---

## 🔍 確認方法3: アプリのログから確認

### 開発者コンソールで確認

#### iOS (Xcode)
```bash
# Xcodeでアプリを実行
# コンソールで以下を検索:
"✅ AI利用ログ記録"
"Gemini APIでメニュー生成開始"
```

#### Android (Android Studio)
```bash
# Logcatで以下を検索:
"AI_COACHING"
"AI利用ログ記録"
```

---

## 📊 429エラーの原因分析

### ケース1: RPM制限（15回/分）- 最も可能性が高い

**症状:**
- 短時間に何度もメニュー生成を試した
- 1分以内に15回以上のリクエスト

**確認方法:**
- `ai_usage_logs`で同じユーザーの連続リクエストを確認
- タイムスタンプが1分以内に15回以上あるか

**対策:**
- ✅ v1.0.192で実装済み: ローカルカウンターで事前防止
- ✅ v1.0.193で実装済み: シンプルなエラーメッセージ

### ケース2: RPD制限（1,500回/日）

**症状:**
- 1日の総リクエストが1,500回を超えた

**確認方法:**
- Google Cloud Consoleでその日のリクエスト数を確認
- または`ai_usage_logs`でその日のログ数をカウント

**可能性:**
- ユーザー数が少ない場合、この可能性は低い
- 1ユーザーが100回使っても、15ユーザーしかいないことになる

### ケース3: 異常な使用パターン

**症状:**
- 特定のユーザーが異常に多くリクエストを送っている
- ボットやスクリプトによる自動リクエスト

**確認方法:**
- `ai_usage_logs`でユーザー別に集計
- 1ユーザーが1日に100回以上使っている場合は異常

**対策:**
- 現在実装済み: `ai_abuse_prevention_service`で検出

---

## 🎯 推奨アクション

### ステップ1: Google Cloud Consoleで確認（5分）

1. https://console.cloud.google.com/ にアクセス
2. Generative Language API のQuotasを確認
3. 以下をスクリーンショット:
   - 今日のリクエスト数
   - 1分あたりの最大リクエスト数

### ステップ2: Firestore Consoleで確認（5分）

1. https://console.firebase.google.com/ にアクセス
2. `ai_usage_logs` コレクションを開く
3. 今日のログ数を確認
4. 特定ユーザーの異常な使用がないか確認

### ステップ3: 結果の分析

#### パターンA: RPM制限（15回/分）
- **原因**: ユーザーが短時間に何度も試した
- **対策**: ✅ 既に実装済み（v1.0.192-193）

#### パターンB: RPD制限（1,500回/日）
- **原因**: 総ユーザー数が多い、または異常使用
- **対策**: 有料プランへのアップグレード検討

#### パターンC: 異常使用
- **原因**: 特定ユーザーの異常使用
- **対策**: 該当ユーザーのAI機能を制限

---

## 💡 疑問点の解明

### 質問: 「そんなにDLされてないのに上限にいった？」

#### 仮説1: 1ユーザーが何度も試した
- テスト中に同じユーザーが15回以上メニュー生成
- 1分間に15回 = RPM制限

#### 仮説2: 開発・テスト環境での使用
- 開発中に何度もテストした
- 同じAPIキーを共有している

#### 仮説3: エラー再試行の無限ループ
- エラーが発生→自動再試行→エラー→再試行...
- コードを確認: ✅ 無限ループはない

#### 仮説4: 複数の開発者が同時テスト
- チーム内で同時にテスト
- 合計で15回/分を超えた

---

## 🔧 次のステップ

1. **Google Cloud Console** でAPI使用状況を確認
2. **Firestore** で`ai_usage_logs`を確認
3. 結果を報告
4. 必要に応じて追加対策を実装

---

**作成日**: 2025-12-09  
**対応バージョン**: v1.0.193
