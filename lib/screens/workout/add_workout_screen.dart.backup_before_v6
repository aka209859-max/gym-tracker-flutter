import 'package:flutter/material.dart';
import 'package:flutter/cupertino.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart' as firebase_auth;
import 'dart:async';

// SetType enum
enum SetType {
  normal,     // é€šå¸¸
  warmup,     // ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
  superset,   // ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚»ãƒƒãƒˆ
  dropset,    // ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆ
  failure,    // ãƒ•ã‚§ã‚¤ãƒ©ãƒ¼ï¼ˆé™ç•Œã¾ã§ï¼‰
}

// WorkoutSet class
class WorkoutSet {
  final String exerciseName;
  double weight;
  int reps;
  bool isCompleted;
  bool hasAssist;        // è£œåŠ©ã‚ã‚Š
  SetType setType;
  
  // æœ‰é…¸ç´ ç”¨
  double? distance;
  int? duration;
  double? speed;
  
  WorkoutSet({
    required this.exerciseName,
    required this.weight,
    required this.reps,
    this.isCompleted = false,
    this.hasAssist = false,
    this.setType = SetType.normal,
    this.distance,
    this.duration,
    this.speed,
  });
}

class AddWorkoutScreen extends StatefulWidget {
  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã‚‹
  final Map<String, dynamic>? templateData;
  
  const AddWorkoutScreen({super.key, this.templateData});

  @override
  State<AddWorkoutScreen> createState() => _AddWorkoutScreenState();
}

class _AddWorkoutScreenState extends State<AddWorkoutScreen> {
  DateTime _selectedDate = DateTime.now();
  String? _selectedMuscleGroup;
  int _startHour = 9;
  int _startMinute = 0;
  int _endHour = 11;
  int _endMinute = 0;
  final List<WorkoutSet> _sets = [];
  
  // ã‚¿ã‚¤ãƒãƒ¼é–¢é€£
  Timer? _restTimer;
  int _restSeconds = 0;
  bool _isResting = false;
  int _selectedRestDuration = 90;
  final List<int> _restDurations = [30, 60, 90, 120];
  
  // å‰å›è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿
  Map<String, Map<String, dynamic>> _lastWorkoutData = {};
  
  // ãƒ¡ãƒ¢æ©Ÿèƒ½
  final TextEditingController _memoController = TextEditingController();
  
  final Map<String, List<String>> _muscleGroupExercises = {
    'èƒ¸': ['ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹', 'ãƒ€ãƒ³ãƒ™ãƒ«ãƒ—ãƒ¬ã‚¹', 'ã‚¤ãƒ³ã‚¯ãƒ©ã‚¤ãƒ³ãƒ—ãƒ¬ã‚¹', 'ã‚±ãƒ¼ãƒ–ãƒ«ãƒ•ãƒ©ã‚¤', 'ãƒ‡ã‚£ãƒƒãƒ—ã‚¹'],
    'è„š': ['ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ', 'ãƒ¬ãƒƒã‚°ãƒ—ãƒ¬ã‚¹', 'ãƒ¬ãƒƒã‚°ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³', 'ãƒ¬ãƒƒã‚°ã‚«ãƒ¼ãƒ«', 'ã‚«ãƒ¼ãƒ•ãƒ¬ã‚¤ã‚º'],
    'èƒŒä¸­': ['ãƒ‡ãƒƒãƒ‰ãƒªãƒ•ãƒˆ', 'ãƒ©ãƒƒãƒˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³', 'ãƒ™ãƒ³ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ­ã‚¦', 'ã‚·ãƒ¼ãƒ†ãƒƒãƒ‰ãƒ­ã‚¦', 'æ‡¸å‚'],
    'è‚©': ['ã‚·ãƒ§ãƒ«ãƒ€ãƒ¼ãƒ—ãƒ¬ã‚¹', 'ã‚µã‚¤ãƒ‰ãƒ¬ã‚¤ã‚º', 'ãƒ•ãƒ­ãƒ³ãƒˆãƒ¬ã‚¤ã‚º', 'ãƒªã‚¢ãƒ‡ãƒ«ãƒˆãƒ•ãƒ©ã‚¤', 'ã‚¢ãƒƒãƒ—ãƒ©ã‚¤ãƒˆãƒ­ã‚¦'],
    'äºŒé ­': ['ãƒãƒ¼ãƒ™ãƒ«ã‚«ãƒ¼ãƒ«', 'ãƒ€ãƒ³ãƒ™ãƒ«ã‚«ãƒ¼ãƒ«', 'ãƒãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ«', 'ãƒ—ãƒªãƒãƒ£ãƒ¼ã‚«ãƒ¼ãƒ«', 'ã‚±ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ«'],
    'ä¸‰é ­': ['ãƒˆãƒ©ã‚¤ã‚»ãƒ—ã‚¹ã‚¨ã‚¯ã‚¹ãƒ†ãƒ³ã‚·ãƒ§ãƒ³', 'ã‚¹ã‚«ãƒ«ã‚¯ãƒ©ãƒƒã‚·ãƒ£ãƒ¼', 'ã‚±ãƒ¼ãƒ–ãƒ«ãƒ—ãƒƒã‚·ãƒ¥ãƒ€ã‚¦ãƒ³', 'ãƒ‡ã‚£ãƒƒãƒ—ã‚¹', 'ã‚­ãƒƒã‚¯ãƒãƒƒã‚¯'],
    'æœ‰é…¸ç´ ': ['ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°', 'ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°', 'ã‚¨ã‚¢ãƒ­ãƒã‚¤ã‚¯', 'ã‚¹ãƒ†ãƒƒãƒ‘ãƒ¼', 'æ°´æ³³'],
  };

  @override
  void initState() {
    super.initState();
    _loadLastWorkoutData();
    _applyTemplateDataIfProvided();
  }
  
  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
  void _applyTemplateDataIfProvided() {
    if (widget.templateData != null) {
      print('ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨: ${widget.templateData}');
      
      // éƒ¨ä½ã‚’è¨­å®š
      final muscleGroup = widget.templateData!['muscle_group'] as String?;
      if (muscleGroup != null) {
        setState(() {
          _selectedMuscleGroup = muscleGroup;
        });
      }
      
      // ã‚»ãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
      final sets = widget.templateData!['sets'] as List<dynamic>?;
      if (sets != null) {
        setState(() {
          for (var setData in sets) {
            final exerciseName = setData['exercise_name'] as String;
            final weight = (setData['weight'] as num?)?.toDouble() ?? 0.0;
            final reps = setData['reps'] as int? ?? 10;
            
            _sets.add(WorkoutSet(
              exerciseName: exerciseName,
              weight: weight,
              reps: reps,
            ));
          }
          print('âœ… ${_sets.length}ã‚»ãƒƒãƒˆã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰é©ç”¨ã—ã¾ã—ãŸ');
        });
      }
    }
  }

  @override
  void dispose() {
    _restTimer?.cancel();
    _memoController.dispose();
    super.dispose();
  }

  // å‰å›ã®ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  Future<void> _loadLastWorkoutData() async {
    try {
      final user = firebase_auth.FirebaseAuth.instance.currentUser;
      if (user == null) return;

      final snapshot = await FirebaseFirestore.instance
          .collection('workout_logs')
          .where('user_id', isEqualTo: user.uid)
          .orderBy('date', descending: true)
          .limit(1)
          .get();

      if (snapshot.docs.isNotEmpty) {
        final data = snapshot.docs.first.data();
        final sets = data['sets'] as List<dynamic>? ?? [];
        
        for (final set in sets) {
          if (set is Map<String, dynamic>) {
            final exerciseName = set['exercise_name'] as String?;
            if (exerciseName != null) {
              _lastWorkoutData[exerciseName] = {
                'weight': (set['weight'] as num?)?.toDouble() ?? 0.0,
                'reps': set['reps'] as int? ?? 10,
              };
            }
          }
        }
        if (mounted) setState(() {});
      }
    } catch (e) {
      debugPrint('å‰å›ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: $e');
    }
  }

  // ä¼‘æ†©ã‚¿ã‚¤ãƒãƒ¼è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  void _showRestTimerSettings() {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ä¼‘æ†©æ™‚é–“ã‚’è¨­å®š'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: _restDurations.map((duration) {
            return RadioListTile<int>(
              title: Text('${duration}ç§’'),
              value: duration,
              groupValue: _selectedRestDuration,
              onChanged: (value) {
                setState(() => _selectedRestDuration = value!);
                Navigator.pop(context);
              },
            );
          }).toList(),
        ),
      ),
    );
  }

  // ã‚«ã‚¹ã‚¿ãƒ ç¨®ç›®è¿½åŠ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  Future<void> _showAddCustomExerciseDialog() async {
    final controller = TextEditingController();
    final result = await showDialog<String>(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ç¨®ç›®ã‚’è¿½åŠ ï¼ˆã‚«ã‚¹ã‚¿ãƒ ï¼‰'),
        content: TextField(
          controller: controller,
          decoration: const InputDecoration(
            hintText: 'ç¨®ç›®åã‚’å…¥åŠ›',
            border: OutlineInputBorder(),
          ),
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('ã‚­ãƒ£ãƒ³ã‚»ãƒ«'),
          ),
          ElevatedButton(
            onPressed: () => Navigator.pop(context, controller.text),
            child: const Text('è¿½åŠ '),
          ),
        ],
      ),
    );
    if (result != null && result.isNotEmpty) {
      setState(() {
        if (!_muscleGroupExercises[_selectedMuscleGroup]!.contains(result)) {
          _muscleGroupExercises[_selectedMuscleGroup]!.add(result);
        }
        _addSet(result);
      });
    }
  }

  // ã‚»ãƒƒãƒˆè¿½åŠ 
  void _addSet(String exerciseName) {
    setState(() {
      // å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¼•ãç¶™ã
      WorkoutSet? lastSet;
      for (int i = _sets.length - 1; i >= 0; i--) {
        if (_sets[i].exerciseName == exerciseName) {
          lastSet = _sets[i];
          break;
        }
      }
      
      _sets.add(WorkoutSet(
        exerciseName: exerciseName,
        weight: lastSet?.weight ?? 0.0,
        reps: lastSet?.reps ?? 10,
        setType: SetType.normal,
      ));
    });
  }

  // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
  void _startRestTimer() {
    setState(() {
      _isResting = true;
      _restSeconds = _selectedRestDuration;
    });
    
    _restTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
      setState(() {
        if (_restSeconds > 0) {
          _restSeconds--;
        } else {
          _stopRestTimer();
        }
      });
    });
  }

  // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
  void _stopRestTimer() {
    _restTimer?.cancel();
    setState(() {
      _isResting = false;
      _restSeconds = 0;
    });
  }

  // ä¿å­˜å‡¦ç†
  Future<void> _saveWorkout() async {
    if (_selectedMuscleGroup == null || _sets.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('éƒ¨ä½ã¨ç¨®ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„')),
      );
      return;
    }

    try {
      final user = firebase_auth.FirebaseAuth.instance.currentUser;
      if (user == null) return;

      final startTime = DateTime(
        _selectedDate.year,
        _selectedDate.month,
        _selectedDate.day,
        _startHour,
        _startMinute,
      );
      
      final endTime = DateTime(
        _selectedDate.year,
        _selectedDate.month,
        _selectedDate.day,
        _endHour,
        _endMinute,
      );

      final setsData = _sets.map((set) => {
        'exercise_name': set.exerciseName,
        'weight': set.weight,
        'reps': set.reps,
        'type': set.setType.toString().split('.').last,
        'has_assist': set.hasAssist,
        'is_completed': set.isCompleted,
      }).toList();

      final workoutDoc = await FirebaseFirestore.instance.collection('workout_logs').add({
        'user_id': user.uid,
        'muscle_group': _selectedMuscleGroup,
        'date': Timestamp.fromDate(_selectedDate),
        'start_time': Timestamp.fromDate(startTime),
        'end_time': Timestamp.fromDate(endTime),
        'sets': setsData,
      });

      // ãƒ¡ãƒ¢ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°ä¿å­˜
      if (_memoController.text.isNotEmpty) {
        await FirebaseFirestore.instance.collection('workout_notes').add({
          'user_id': user.uid,
          'workout_session_id': workoutDoc.id,
          'content': _memoController.text,
          'created_at': Timestamp.now(),
          'updated_at': Timestamp.now(),
        });
      }

      if (mounted) {
        Navigator.pop(context, true);
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸ'), backgroundColor: Colors.green),
        );
      }
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: $e')),
        );
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²'),
        actions: [
          if (_isResting)
            Center(
              child: Padding(
                padding: const EdgeInsets.symmetric(horizontal: 16),
                child: Text(
                  'ä¼‘æ†©: ${_restSeconds}ç§’',
                  style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                ),
              ),
            ),
          IconButton(
            icon: const Icon(Icons.timer),
            onPressed: _showRestTimerSettings,
            tooltip: 'ä¼‘æ†©æ™‚é–“è¨­å®š',
          ),
        ],
      ),
      body: Column(
        children: [
          // éƒ¨ä½é¸æŠ
          if (_selectedMuscleGroup == null)
            Expanded(child: _buildMuscleGroupSelection())
          else
            Expanded(
              child: Column(
                children: [
                  _buildSelectedMuscleGroupHeader(),
                  Expanded(child: _buildExerciseList()),
                ],
              ),
            ),
        ],
      ),
      bottomNavigationBar: _selectedMuscleGroup != null && _sets.isNotEmpty
          ? SafeArea(
              child: Padding(
                padding: const EdgeInsets.all(16),
                child: ElevatedButton(
                  onPressed: _saveWorkout,
                  style: ElevatedButton.styleFrom(
                    padding: const EdgeInsets.symmetric(vertical: 16),
                    backgroundColor: Colors.blue.shade700,
                  ),
                  child: const Text('è¨˜éŒ²ã‚’ä¿å­˜', style: TextStyle(fontSize: 18, color: Colors.white)),
                ),
              ),
            )
          : null,
    );
  }

  // éƒ¨ä½é¸æŠç”»é¢
  Widget _buildMuscleGroupSelection() {
    return GridView.builder(
      padding: const EdgeInsets.all(16),
      gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: 2,
        childAspectRatio: 1.5,
        crossAxisSpacing: 12,
        mainAxisSpacing: 12,
      ),
      itemCount: _muscleGroupExercises.keys.length,
      itemBuilder: (context, index) {
        final muscleGroup = _muscleGroupExercises.keys.elementAt(index);
        return Card(
          child: InkWell(
            onTap: () => setState(() => _selectedMuscleGroup = muscleGroup),
            child: Center(
              child: Text(
                muscleGroup,
                style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
              ),
            ),
          ),
        );
      },
    );
  }

  // é¸æŠã•ã‚ŒãŸéƒ¨ä½ã®ãƒ˜ãƒƒãƒ€ãƒ¼
  Widget _buildSelectedMuscleGroupHeader() {
    return Container(
      padding: const EdgeInsets.all(16),
      color: Colors.blue.shade700,
      child: Row(
        children: [
          Text(
            _selectedMuscleGroup!,
            style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: Colors.white),
          ),
          const Spacer(),
          TextButton(
            onPressed: () => setState(() {
              _selectedMuscleGroup = null;
              _sets.clear();
            }),
            child: const Text('å¤‰æ›´', style: TextStyle(color: Colors.white)),
          ),
        ],
      ),
    );
  }

  // ç¨®ç›®ãƒªã‚¹ãƒˆ
  Widget _buildExerciseList() {
    final exercises = _muscleGroupExercises[_selectedMuscleGroup] ?? [];
    final exerciseGroups = <String, List<WorkoutSet>>{};
    
    for (final set in _sets) {
      exerciseGroups.putIfAbsent(set.exerciseName, () => []).add(set);
    }

    return SingleChildScrollView(
      child: Column(
        children: [
          // ç¨®ç›®é¸æŠ
          Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const Text('ç¨®ç›®ã‚’é¸æŠ', style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                const SizedBox(height: 12),
                Wrap(
                  spacing: 8,
                  runSpacing: 8,
                  children: [
                    ...exercises.map((exercise) {
                      return ActionChip(
                        label: Text(exercise),
                        onPressed: () => _addSet(exercise),
                        backgroundColor: exerciseGroups.containsKey(exercise) 
                            ? Colors.blue.shade100 
                            : null,
                      );
                    }).toList(),
                    ActionChip(
                      label: const Row(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Icon(Icons.add, size: 16),
                          SizedBox(width: 4),
                          Text('ç¨®ç›®ã‚’è¿½åŠ ï¼ˆã‚«ã‚¹ã‚¿ãƒ ï¼‰'),
                        ],
                      ),
                      onPressed: _showAddCustomExerciseDialog,
                      backgroundColor: Colors.green.shade100,
                    ),
                  ],
                ),
              ],
            ),
          ),
          
          // ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ
          ...exerciseGroups.entries.map((entry) {
            return _buildExerciseCard(entry.key, entry.value);
          }).toList(),
          
          // ãƒ¡ãƒ¢å…¥åŠ›æ¬„
          if (exerciseGroups.isNotEmpty)
            Padding(
              padding: const EdgeInsets.all(16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text(
                    'ğŸ“ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¡ãƒ¢',
                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                  ),
                  const SizedBox(height: 12),
                  TextField(
                    controller: _memoController,
                    maxLines: 5,
                    decoration: InputDecoration(
                      hintText: 'ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã«ã¤ã„ã¦ãƒ¡ãƒ¢ã‚’æ®‹ã—ã¾ã—ã‚‡ã†\nä¾‹: èª¿å­ãŒè‰¯ã‹ã£ãŸã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ„è­˜ã—ãŸã€é‡é‡ã‚’ä¸Šã’ãŸ ãªã©',
                      border: OutlineInputBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      filled: true,
                      fillColor: Colors.grey.shade50,
                      contentPadding: const EdgeInsets.all(16),
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    'ãƒ¡ãƒ¢ã¯å¾Œã‹ã‚‰ç¢ºèªãƒ»ç·¨é›†ã§ãã¾ã™',
                    style: TextStyle(fontSize: 12, color: Colors.grey.shade600),
                  ),
                ],
              ),
            ),
        ],
      ),
    );
  }

  // ç¨®ç›®ã‚«ãƒ¼ãƒ‰
  Widget _buildExerciseCard(String exerciseName, List<WorkoutSet> sets) {
    final lastData = _lastWorkoutData[exerciseName];
    
    return Card(
      margin: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                const Icon(Icons.fitness_center, color: Colors.blue),
                const SizedBox(width: 8),
                Text(exerciseName, style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
                const Spacer(),
                IconButton(
                  icon: const Icon(Icons.add_circle, color: Colors.blue),
                  onPressed: () => _addSet(exerciseName),
                ),
              ],
            ),
            if (lastData != null) ...[
              const SizedBox(height: 8),
              Container(
                padding: const EdgeInsets.all(8),
                decoration: BoxDecoration(
                  color: Colors.purple.shade50,
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(color: Colors.purple.shade200),
                ),
                child: Row(
                  children: [
                    const Icon(Icons.lightbulb, size: 16, color: Colors.purple),
                    const SizedBox(width: 8),
                    Text('ğŸ’¡ å‰å›è¨˜éŒ²', style: TextStyle(fontSize: 12, fontWeight: FontWeight.bold, color: Colors.purple.shade700)),
                    const SizedBox(width: 8),
                    Text('ä»Šæ—¥ã®è¨˜éŒ²ãŒæ¬¡å›ã®ç›®æ¨™ã«ãªã‚Šã¾ã™ã€‚å…¨åŠ›ã§æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼', style: TextStyle(fontSize: 11, color: Colors.purple.shade600)),
                  ],
                ),
              ),
            ],
            const SizedBox(height: 12),
            ...sets.asMap().entries.map((entry) {
              final index = entry.key;
              final globalIndex = _sets.indexOf(entry.value);
              return _buildSetRow(globalIndex, entry.value, index + 1);
            }).toList(),
          ],
        ),
      ),
    );
  }

  // ã‚»ãƒƒãƒˆè¡Œ
  Widget _buildSetRow(int globalIndex, WorkoutSet set, int setNumber) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 8),
      child: Row(
        children: [
          // ã‚»ãƒƒãƒˆç•ªå·
          Container(
            width: 32,
            height: 32,
            decoration: BoxDecoration(
              color: set.isCompleted ? Colors.green : Colors.grey.shade300,
              shape: BoxShape.circle,
            ),
            child: Center(
              child: Text(
                '$setNumber',
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  color: set.isCompleted ? Colors.white : Colors.black,
                ),
              ),
            ),
          ),
          const SizedBox(width: 12),
          
          // SetTypeé¸æŠï¼ˆæœ‰é…¸ç´ ä»¥å¤–ï¼‰
          if (_selectedMuscleGroup != 'æœ‰é…¸ç´ ') ...[
            InkWell(
              onTap: () => _showSetTypeDialog(globalIndex),
              child: Container(
                padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                decoration: BoxDecoration(
                  border: Border.all(color: _getSetTypeColor(set.setType)),
                  borderRadius: BorderRadius.circular(4),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(_getSetTypeIcon(set.setType), size: 16, color: _getSetTypeColor(set.setType)),
                    const SizedBox(width: 4),
                    Text(
                      _getSetTypeLabel(set.setType),
                      style: TextStyle(fontSize: 12, color: _getSetTypeColor(set.setType)),
                    ),
                  ],
                ),
              ),
            ),
            const SizedBox(width: 8),
          ],
          
          // é‡é‡å…¥åŠ›
          SizedBox(
            width: 70,
            child: TextField(
              decoration: const InputDecoration(
                labelText: 'kg',
                border: OutlineInputBorder(),
                contentPadding: EdgeInsets.symmetric(horizontal: 8, vertical: 8),
              ),
              keyboardType: TextInputType.number,
              controller: TextEditingController(text: set.weight.toString()),
              onChanged: (value) {
                setState(() {
                  set.weight = double.tryParse(value) ?? 0.0;
                });
              },
            ),
          ),
          const SizedBox(width: 8),
          
          // å›æ•°å…¥åŠ›
          SizedBox(
            width: 60,
            child: TextField(
              decoration: const InputDecoration(
                labelText: 'å›',
                border: OutlineInputBorder(),
                contentPadding: EdgeInsets.symmetric(horizontal: 8, vertical: 8),
              ),
              keyboardType: TextInputType.number,
              controller: TextEditingController(text: set.reps.toString()),
              onChanged: (value) {
                setState(() {
                  set.reps = int.tryParse(value) ?? 0;
                });
              },
            ),
          ),
          const SizedBox(width: 8),
          
          // è£œåŠ©ãƒˆã‚°ãƒ«
          IconButton(
            icon: Icon(
              set.hasAssist ? Icons.handshake : Icons.person,
              color: set.hasAssist ? Colors.orange : Colors.grey,
            ),
            onPressed: () {
              setState(() {
                set.hasAssist = !set.hasAssist;
              });
            },
            tooltip: set.hasAssist ? 'è£œåŠ©ã‚ã‚Š' : 'è£œåŠ©ãªã—',
          ),
          
          // å®Œäº†ãƒˆã‚°ãƒ«
          IconButton(
            icon: Icon(
              set.isCompleted ? Icons.check_circle : Icons.check_circle_outline,
              color: set.isCompleted ? Colors.green : Colors.grey,
            ),
            onPressed: () {
              setState(() {
                set.isCompleted = !set.isCompleted;
                if (set.isCompleted && !_isResting) {
                  _startRestTimer();
                }
              });
            },
          ),
          
          // å‰Šé™¤
          IconButton(
            icon: const Icon(Icons.delete, color: Colors.red),
            onPressed: () {
              setState(() {
                _sets.removeAt(globalIndex);
              });
            },
          ),
        ],
      ),
    );
  }

  // SetTypeé¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°
  void _showSetTypeDialog(int setIndex) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('ã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠ'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: SetType.values.map((type) {
            return ListTile(
              leading: Icon(_getSetTypeIcon(type), color: _getSetTypeColor(type)),
              title: Text(_getSetTypeLabel(type)),
              onTap: () {
                setState(() {
                  _sets[setIndex].setType = type;
                });
                Navigator.pop(context);
              },
            );
          }).toList(),
        ),
      ),
    );
  }

  // SetTypeé–¢é€£ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼
  Color _getSetTypeColor(SetType type) {
    switch (type) {
      case SetType.warmup:
        return Colors.orange;
      case SetType.superset:
        return Colors.purple;
      case SetType.dropset:
        return Colors.red;
      case SetType.failure:
        return Colors.pink;
      default:
        return Colors.blue;
    }
  }

  IconData _getSetTypeIcon(SetType type) {
    switch (type) {
      case SetType.warmup:
        return Icons.thermostat;
      case SetType.superset:
        return Icons.bolt;
      case SetType.dropset:
        return Icons.trending_down;
      case SetType.failure:
        return Icons.warning;
      default:
        return Icons.fitness_center;
    }
  }

  String _getSetTypeLabel(SetType type) {
    switch (type) {
      case SetType.warmup:
        return 'ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—';
      case SetType.superset:
        return 'ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚»ãƒƒãƒˆ';
      case SetType.dropset:
        return 'ãƒ‰ãƒ­ãƒƒãƒ—ã‚»ãƒƒãƒˆ';
      case SetType.failure:
        return 'ãƒ•ã‚§ã‚¤ãƒ©ãƒ¼';
      default:
        return 'é€šå¸¸';
    }
  }
}
